{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/form.js"],"names":["Form","id","idBase","instance","setInstance","useForm","html","setFormData","setFormDataDebounced","isStillMounted","setHTML","formData","current","noticesStore","createNotice","performFetch","path","method","data","form_data","widget","rendered_form","message","response","previousHTML","form","Control","onChange","onSave","controlRef","formRef","hasBeenAdded","window","jQuery","$","document","trigger","handler","serializeForm","on","off","addEventListener","removeEventListener","handleSubmit","event","preventDefault","target","number","URLSearchParams","Array","from","FormData","toString"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { debounce } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { useDispatch } from '@wordpress/data';\nimport { store as noticesStore } from '@wordpress/notices';\nimport { __ } from '@wordpress/i18n';\nimport {\n\tuseEffect,\n\tuseRef,\n\tuseState,\n\tuseCallback,\n\tRawHTML,\n} from '@wordpress/element';\nimport apiFetch from '@wordpress/api-fetch';\nimport { Button } from '@wordpress/components';\nimport { useInstanceId } from '@wordpress/compose';\n\nexport default function Form( { id, idBase, instance, setInstance } ) {\n\tconst { html, setFormData } = useForm( {\n\t\tid,\n\t\tidBase,\n\t\tinstance,\n\t\tsetInstance,\n\t} );\n\n\tconst setFormDataDebounced = useCallback( debounce( setFormData, 300 ), [\n\t\tsetFormData,\n\t] );\n\n\treturn (\n\t\t<Control\n\t\t\tid={ id }\n\t\t\tidBase={ idBase }\n\t\t\thtml={ html }\n\t\t\tonChange={ setFormDataDebounced }\n\t\t\tonSave={ setFormData }\n\t\t/>\n\t);\n}\n\nfunction useForm( { id, idBase, instance, setInstance } ) {\n\tconst isStillMounted = useRef( false );\n\tconst [ html, setHTML ] = useState( null );\n\tconst [ formData, setFormData ] = useState( null );\n\n\tuseEffect( () => {\n\t\tisStillMounted.current = true;\n\t\treturn () => ( isStillMounted.current = false );\n\t}, [] );\n\n\tconst { createNotice } = useDispatch( noticesStore );\n\n\tuseEffect( () => {\n\t\tconst performFetch = async () => {\n\t\t\tif ( id ) {\n\t\t\t\t// Updating a widget that does not extend WP_Widget.\n\t\t\t\ttry {\n\t\t\t\t\tlet widget;\n\t\t\t\t\tif ( formData ) {\n\t\t\t\t\t\twidget = await apiFetch( {\n\t\t\t\t\t\t\tpath: `/wp/v2/widgets/${ id }?context=edit`,\n\t\t\t\t\t\t\tmethod: 'PUT',\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\tform_data: formData,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t} );\n\t\t\t\t\t} else {\n\t\t\t\t\t\twidget = await apiFetch( {\n\t\t\t\t\t\t\tpath: `/wp/v2/widgets/${ id }?context=edit`,\n\t\t\t\t\t\t\tmethod: 'GET',\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t\tif ( isStillMounted.current ) {\n\t\t\t\t\t\tsetHTML( widget.rendered_form );\n\t\t\t\t\t}\n\t\t\t\t} catch ( error ) {\n\t\t\t\t\tcreateNotice(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\terror?.message ??\n\t\t\t\t\t\t\t__( 'An error occured while updating the widget.' )\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} else if ( idBase ) {\n\t\t\t\t// Updating a widget that extends WP_Widget.\n\t\t\t\ttry {\n\t\t\t\t\tconst response = await apiFetch( {\n\t\t\t\t\t\tpath: `/wp/v2/widget-types/${ idBase }/encode`,\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tinstance,\n\t\t\t\t\t\t\tform_data: formData,\n\t\t\t\t\t\t},\n\t\t\t\t\t} );\n\t\t\t\t\tif ( isStillMounted.current ) {\n\t\t\t\t\t\tsetInstance( response.instance );\n\t\t\t\t\t\t// Only set HTML the first time so that we don't cause a\n\t\t\t\t\t\t// focus loss by remounting the form.\n\t\t\t\t\t\tsetHTML(\n\t\t\t\t\t\t\t( previousHTML ) => previousHTML ?? response.form\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t} catch ( error ) {\n\t\t\t\t\tcreateNotice(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\terror?.message ??\n\t\t\t\t\t\t\t__( 'An error occured while updating the widget.' )\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tperformFetch();\n\t}, [\n\t\tid,\n\t\tidBase,\n\t\tsetInstance,\n\t\tformData,\n\t\t// Do not trigger when `instance` changes so that we don't make two API\n\t\t// requests when there is form input.\n\t] );\n\n\treturn { html, setFormData };\n}\n\nfunction Control( { id, idBase, html, onChange, onSave } ) {\n\tconst controlRef = useRef();\n\tconst formRef = useRef();\n\n\t// Trigger 'widget-added' when widget is ready and 'widget-updated' when\n\t// widget changes. This event is what widgets' scripts use to initialize,\n\t// attach events, etc. The event must be fired using jQuery's event bus as\n\t// this is what widget scripts expect. If jQuery is not loaded, do nothing -\n\t// some widgets will still work regardless.\n\tconst hasBeenAdded = useRef( false );\n\tuseEffect( () => {\n\t\tif ( ! window.jQuery ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { jQuery: $ } = window;\n\n\t\tif ( html ) {\n\t\t\t$( document ).trigger(\n\t\t\t\thasBeenAdded.current ? 'widget-updated' : 'widget-added',\n\t\t\t\t[ $( controlRef.current ) ]\n\t\t\t);\n\t\t\thasBeenAdded.current = true;\n\t\t}\n\t}, [\n\t\thtml,\n\t\t// Include id and idBase in the deps so that widget-updated is triggered\n\t\t// if they change.\n\t\tid,\n\t\tidBase,\n\t] );\n\n\t// Prefer jQuery 'change' event instead of the native 'change' event because\n\t// many widgets use jQuery's event bus to trigger an update.\n\tuseEffect( () => {\n\t\tconst handler = () => onChange( serializeForm( formRef.current ) );\n\n\t\tif ( window.jQuery ) {\n\t\t\tconst { jQuery: $ } = window;\n\t\t\t$( formRef.current ).on( 'change', null, handler );\n\t\t\treturn () => $( formRef.current ).off( 'change', null, handler );\n\t\t}\n\n\t\tformRef.current.addEventListener( 'change', handler );\n\t\treturn () => formRef.current.removeEventListener( 'change', handler );\n\t}, [ onChange ] );\n\n\t// Non-multi widgets can be saved via a Save button.\n\tconst handleSubmit = ( event ) => {\n\t\tevent.preventDefault();\n\t\tonSave( serializeForm( event.target ) );\n\t};\n\n\t// We can't use the real widget number as this is calculated by the server\n\t// and we may not ever *actually* save this widget. Instead, use a fake but\n\t// unique number.\n\tconst number = useInstanceId( Control );\n\n\treturn (\n\t\t<div ref={ controlRef } className=\"widget open\">\n\t\t\t<div className=\"widget-inside\">\n\t\t\t\t<form\n\t\t\t\t\tref={ formRef }\n\t\t\t\t\tclassName=\"form\"\n\t\t\t\t\tmethod=\"post\"\n\t\t\t\t\tonSubmit={ handleSubmit }\n\t\t\t\t>\n\t\t\t\t\t{ /* Many widgets expect these hidden inputs to exist in the DOM. */ }\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"widget-id\"\n\t\t\t\t\t\tclassName=\"widget-id\"\n\t\t\t\t\t\tvalue={ id ?? `${ idBase }-${ number }` }\n\t\t\t\t\t/>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"id_base\"\n\t\t\t\t\t\tclassName=\"id_base\"\n\t\t\t\t\t\tvalue={ idBase ?? id }\n\t\t\t\t\t/>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"widget-width\"\n\t\t\t\t\t\tclassName=\"widget-width\"\n\t\t\t\t\t\tvalue=\"250\"\n\t\t\t\t\t/>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"widget-height\"\n\t\t\t\t\t\tclassName=\"widget-height\"\n\t\t\t\t\t\tvalue=\"200\"\n\t\t\t\t\t/>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"widget_number\"\n\t\t\t\t\t\tclassName=\"widget_number\"\n\t\t\t\t\t\tvalue={ idBase ? number : '' }\n\t\t\t\t\t/>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\tname=\"add_new\"\n\t\t\t\t\t\tclassName=\"add_new\"\n\t\t\t\t\t\tvalue=\"\"\n\t\t\t\t\t/>\n\t\t\t\t\t<RawHTML className=\"widget-content\">{ html }</RawHTML>\n\t\t\t\t\t{ id && (\n\t\t\t\t\t\t<Button type=\"submit\" isPrimary>\n\t\t\t\t\t\t\t{ __( 'Save' ) }\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t) }\n\t\t\t\t</form>\n\t\t\t</div>\n\t\t</div>\n\t);\n}\n\nfunction serializeForm( form ) {\n\treturn new window.URLSearchParams(\n\t\tArray.from( new window.FormData( form ) )\n\t).toString();\n}\n"]}