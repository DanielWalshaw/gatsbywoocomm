{"version":3,"sources":["@wordpress/block-editor/src/components/block-navigation/use-block-navigation-drop-zone.js"],"names":["isPointContainedByRect","point","rect","left","x","right","top","y","bottom","isNestingGesture","blockCenterX","width","ALLOWED_DROP_EDGES","getBlockNavigationDropTarget","blocksData","position","candidateEdge","candidateBlockData","candidateDistance","candidateRect","blockData","isDraggedBlock","element","getBoundingClientRect","distance","edge","isCursorWithinBlock","undefined","index","indexOf","previousBlockData","rootClientId","isDraggingBelow","canInsertDraggedBlocksAsChild","innerBlockCount","clientId","blockIndex","dropPosition","canInsertDraggedBlocksAsSibling","offset","useBlockNavigationDropZone","blockEditorStore","getBlockRootClientId","getBlockIndex","getBlockCount","getDraggedBlockClientIds","canInsertBlocks","target","setTarget","targetRootClientId","targetBlockIndex","onBlockDrop","throttled","event","currentTarget","clientX","clientY","isBlockDrag","dataTransfer","getData","draggedBlockClientIds","blockElements","Array","from","querySelectorAll","map","blockElement","dataset","block","includes","newTarget","ref","onDrop","onDragOver","onDragEnd","cancel"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useSelect } from '@wordpress/data';\nimport { useState, useCallback } from '@wordpress/element';\nimport {\n\tuseThrottle,\n\t__experimentalUseDropZone as useDropZone,\n} from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport { getDistanceToNearestEdge } from '../../utils/math';\nimport useOnBlockDrop from '../use-on-block-drop';\nimport { store as blockEditorStore } from '../../store';\n\n/** @typedef {import('../../utils/math').WPPoint} WPPoint */\n\n/**\n * The type of a drag event.\n *\n * @typedef {'default'|'file'|'html'} WPDragEventType\n */\n\n/**\n * An array representing data for blocks in the DOM used by drag and drop.\n *\n * @typedef {Object} WPBlockNavigationDropZoneBlocks\n * @property {string}  clientId                        The client id for the block.\n * @property {string}  rootClientId                    The root client id for the block.\n * @property {number}  blockIndex                      The block's index.\n * @property {Element} element                         The DOM element representing the block.\n * @property {number}  innerBlockCount                 The number of inner blocks the block has.\n * @property {boolean} isDraggedBlock                  Whether the block is currently being dragged.\n * @property {boolean} canInsertDraggedBlocksAsSibling Whether the dragged block can be a sibling of this block.\n * @property {boolean} canInsertDraggedBlocksAsChild   Whether the dragged block can be a child of this block.\n */\n\n/**\n * An object containing details of a drop target.\n *\n * @typedef {Object} WPBlockNavigationDropZoneTarget\n * @property {string}                   blockIndex   The insertion index.\n * @property {string}                   rootClientId The root client id for the block.\n * @property {string|undefined}         clientId     The client id for the block.\n * @property {'top'|'bottom'|'inside'}  dropPosition The position relative to the block that the user is dropping to.\n *                                                   'inside' refers to nesting as an inner block.\n */\n\n/**\n * Is the point contained by the rectangle.\n *\n * @param {WPPoint} point The point.\n * @param {DOMRect} rect  The rectangle.\n *\n * @return {boolean} True if the point is contained by the rectangle, false otherwise.\n */\nfunction isPointContainedByRect( point, rect ) {\n\treturn (\n\t\trect.left <= point.x &&\n\t\trect.right >= point.x &&\n\t\trect.top <= point.y &&\n\t\trect.bottom >= point.y\n\t);\n}\n\n/**\n * Determines whether the user positioning the dragged block to nest as an\n * inner block.\n *\n * Presently this is determined by whether the cursor is on the right hand side\n * of the block.\n *\n * @param {WPPoint} point The point representing the cursor position when dragging.\n * @param {DOMRect} rect  The rectangle.\n */\nfunction isNestingGesture( point, rect ) {\n\tconst blockCenterX = rect.left + rect.width / 2;\n\treturn point.x > blockCenterX;\n}\n\n// Block navigation is always a vertical list, so only allow dropping\n// to the above or below a block.\nconst ALLOWED_DROP_EDGES = [ 'top', 'bottom' ];\n\n/**\n * Given blocks data and the cursor position, compute the drop target.\n *\n * @param {WPBlockNavigationDropZoneBlocks} blocksData Data about the blocks in block navigation.\n * @param {WPPoint} position The point representing the cursor position when dragging.\n *\n * @return {WPBlockNavigationDropZoneTarget} An object containing data about the drop target.\n */\nfunction getBlockNavigationDropTarget( blocksData, position ) {\n\tlet candidateEdge;\n\tlet candidateBlockData;\n\tlet candidateDistance;\n\tlet candidateRect;\n\n\tfor ( const blockData of blocksData ) {\n\t\tif ( blockData.isDraggedBlock ) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst rect = blockData.element.getBoundingClientRect();\n\t\tconst [ distance, edge ] = getDistanceToNearestEdge(\n\t\t\tposition,\n\t\t\trect,\n\t\t\tALLOWED_DROP_EDGES\n\t\t);\n\n\t\tconst isCursorWithinBlock = isPointContainedByRect( position, rect );\n\t\tif (\n\t\t\tcandidateDistance === undefined ||\n\t\t\tdistance < candidateDistance ||\n\t\t\tisCursorWithinBlock\n\t\t) {\n\t\t\tcandidateDistance = distance;\n\n\t\t\tconst index = blocksData.indexOf( blockData );\n\t\t\tconst previousBlockData = blocksData[ index - 1 ];\n\n\t\t\t// If dragging near the top of a block and the preceding block\n\t\t\t// is at the same level, use the preceding block as the candidate\n\t\t\t// instead, as later it makes determining a nesting drop easier.\n\t\t\tif (\n\t\t\t\tedge === 'top' &&\n\t\t\t\tpreviousBlockData &&\n\t\t\t\tpreviousBlockData.rootClientId === blockData.rootClientId &&\n\t\t\t\t! previousBlockData.isDraggedBlock\n\t\t\t) {\n\t\t\t\tcandidateBlockData = previousBlockData;\n\t\t\t\tcandidateEdge = 'bottom';\n\t\t\t\tcandidateRect = previousBlockData.element.getBoundingClientRect();\n\t\t\t} else {\n\t\t\t\tcandidateBlockData = blockData;\n\t\t\t\tcandidateEdge = edge;\n\t\t\t\tcandidateRect = rect;\n\t\t\t}\n\n\t\t\t// If the mouse position is within the block, break early\n\t\t\t// as the user would intend to drop either before or after\n\t\t\t// this block.\n\t\t\t//\n\t\t\t// This solves an issue where some rows in the block navigation\n\t\t\t// tree overlap slightly due to sub-pixel rendering.\n\t\t\tif ( isCursorWithinBlock ) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tif ( ! candidateBlockData ) {\n\t\treturn;\n\t}\n\n\tconst isDraggingBelow = candidateEdge === 'bottom';\n\n\t// If the user is dragging towards the bottom of the block check whether\n\t// they might be trying to nest the block as a child.\n\t// If the block already has inner blocks, this should always be treated\n\t// as nesting since the next block in the tree will be the first child.\n\tif (\n\t\tisDraggingBelow &&\n\t\tcandidateBlockData.canInsertDraggedBlocksAsChild &&\n\t\t( candidateBlockData.innerBlockCount > 0 ||\n\t\t\tisNestingGesture( position, candidateRect ) )\n\t) {\n\t\treturn {\n\t\t\trootClientId: candidateBlockData.clientId,\n\t\t\tblockIndex: 0,\n\t\t\tdropPosition: 'inside',\n\t\t};\n\t}\n\n\t// If dropping as a sibling, but block cannot be inserted in\n\t// this context, return early.\n\tif ( ! candidateBlockData.canInsertDraggedBlocksAsSibling ) {\n\t\treturn;\n\t}\n\n\tconst offset = isDraggingBelow ? 1 : 0;\n\treturn {\n\t\trootClientId: candidateBlockData.rootClientId,\n\t\tclientId: candidateBlockData.clientId,\n\t\tblockIndex: candidateBlockData.blockIndex + offset,\n\t\tdropPosition: candidateEdge,\n\t};\n}\n\n/**\n * A react hook for implementing a drop zone in block navigation.\n *\n * @return {WPBlockNavigationDropZoneTarget} The drop target.\n */\nexport default function useBlockNavigationDropZone() {\n\tconst {\n\t\tgetBlockRootClientId,\n\t\tgetBlockIndex,\n\t\tgetBlockCount,\n\t\tgetDraggedBlockClientIds,\n\t\tcanInsertBlocks,\n\t} = useSelect( blockEditorStore );\n\tconst [ target, setTarget ] = useState();\n\tconst { rootClientId: targetRootClientId, blockIndex: targetBlockIndex } =\n\t\ttarget || {};\n\n\tconst onBlockDrop = useOnBlockDrop( targetRootClientId, targetBlockIndex );\n\tconst throttled = useThrottle(\n\t\tuseCallback( ( event, currentTarget ) => {\n\t\t\tconst position = { x: event.clientX, y: event.clientY };\n\t\t\tconst isBlockDrag = !! event.dataTransfer.getData( 'wp-blocks' );\n\n\t\t\tconst draggedBlockClientIds = isBlockDrag\n\t\t\t\t? getDraggedBlockClientIds()\n\t\t\t\t: undefined;\n\n\t\t\tconst blockElements = Array.from(\n\t\t\t\tcurrentTarget.querySelectorAll( '[data-block]' )\n\t\t\t);\n\n\t\t\tconst blocksData = blockElements.map( ( blockElement ) => {\n\t\t\t\tconst clientId = blockElement.dataset.block;\n\t\t\t\tconst rootClientId = getBlockRootClientId( clientId );\n\n\t\t\t\treturn {\n\t\t\t\t\tclientId,\n\t\t\t\t\trootClientId,\n\t\t\t\t\tblockIndex: getBlockIndex( clientId, rootClientId ),\n\t\t\t\t\telement: blockElement,\n\t\t\t\t\tisDraggedBlock: isBlockDrag\n\t\t\t\t\t\t? draggedBlockClientIds.includes( clientId )\n\t\t\t\t\t\t: false,\n\t\t\t\t\tinnerBlockCount: getBlockCount( clientId ),\n\t\t\t\t\tcanInsertDraggedBlocksAsSibling: isBlockDrag\n\t\t\t\t\t\t? canInsertBlocks( draggedBlockClientIds, rootClientId )\n\t\t\t\t\t\t: true,\n\t\t\t\t\tcanInsertDraggedBlocksAsChild: isBlockDrag\n\t\t\t\t\t\t? canInsertBlocks( draggedBlockClientIds, clientId )\n\t\t\t\t\t\t: true,\n\t\t\t\t};\n\t\t\t} );\n\n\t\t\tconst newTarget = getBlockNavigationDropTarget(\n\t\t\t\tblocksData,\n\t\t\t\tposition\n\t\t\t);\n\n\t\t\tif ( newTarget ) {\n\t\t\t\tsetTarget( newTarget );\n\t\t\t}\n\t\t}, [] ),\n\t\t200\n\t);\n\n\tconst ref = useDropZone( {\n\t\tonDrop: onBlockDrop,\n\t\tonDragOver( event ) {\n\t\t\t// `currentTarget` is only available while the event is being\n\t\t\t// handled, so get it now and pass it to the thottled function.\n\t\t\t// https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget\n\t\t\tthrottled( event, event.currentTarget );\n\t\t},\n\t\tonDragEnd() {\n\t\t\tthrottled.cancel();\n\t\t\tsetTarget( null );\n\t\t},\n\t} );\n\n\treturn { ref, target };\n}\n"]}